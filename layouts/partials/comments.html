<div class="giscus-container">
  <script src="https://giscus.app/client.js"
    data-repo="{{ .Site.Params.giscus.repo }}"
    data-repo-id="{{ .Site.Params.giscus.repoID }}"
    data-category="{{ .Site.Params.giscus.category }}"
    data-category-id="{{ .Site.Params.giscus.categoryID }}"
    data-mapping="{{ .Site.Params.giscus.mapping | default "pathname" }}"
    data-reactions-enabled="{{ .Site.Params.giscus.reactionsEnabled | default "0" }}"
    data-emit-metadata="{{ .Site.Params.giscus.emitMetadata | default "0" }}"
    data-input-position="{{ .Site.Params.giscus.inputPosition | default "bottom" }}"
    data-theme="noborder_light"
    data-lang="{{ .Site.Params.giscus.lang | default "ko" }}"
    crossorigin="anonymous" async>
  </script>
</div>

<script>
(function () {
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');

  function isDark() {
    const pref = localStorage.getItem('pref-theme');
    if (pref === 'dark') return true;
    if (pref === 'light') return false;
    return (
      document.documentElement.classList.contains('dark') ||
      document.body.classList.contains('dark') ||
      prefersDark.matches
    );
  }

  function themeName() {
    return isDark() ? 'noborder_dark' : 'noborder_light';
  }

  function setGiscusTheme(theme) {
    const iframe = document.querySelector('iframe.giscus-frame');
    if (!iframe) return;
    iframe.contentWindow.postMessage(
      { giscus: { setConfig: { theme } } },
      'https://giscus.app'
    );
  }

  // iframe 로드 시점까지 기다렸다가 1회 동기화
  const waitAndApply = () => {
    const i = document.querySelector('iframe.giscus-frame');
    if (i) setGiscusTheme(themeName());
    else requestAnimationFrame(waitAndApply);
  };
  waitAndApply();

  // PaperMod 테마 토글 클릭 시 동기화
  document.addEventListener('click', (e) => {
    if (e.target.closest('.theme-toggle') || e.target.closest('#theme-toggle')) {
      setTimeout(() => setGiscusTheme(themeName()), 60);
    }
  });

  // 시스템 테마 변경 감지
  prefersDark.addEventListener('change', () => setGiscusTheme(themeName()));

  // html/body class 변화도 감지
  const mo = new MutationObserver(() => setGiscusTheme(themeName()));
  mo.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
  mo.observe(document.body, { attributes: true, attributeFilter: ['class'] });
})();
</script>
